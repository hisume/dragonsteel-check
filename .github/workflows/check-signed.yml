name: Check Signed Books

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Prepare state worktree
        run: |
          set -euo pipefail
          git fetch origin state || true
          if git show-ref --verify --quiet refs/heads/state; then
            git worktree add state_repo state
          elif git show-ref --verify --quiet refs/remotes/origin/state; then
            git worktree add -b state state_repo origin/state
          else
            git worktree add state_repo
            cd state_repo
            git checkout --orphan state
            git rm -rf . || true
          fi

      - name: Run signed book check
        run: |
          set -euo pipefail
          mkdir -p out
          prev_arg=""
          if [ -f state_repo/latest.json ]; then
            prev_arg="--previous state_repo/latest.json"
          fi
          python3 check_signed.py \
            --output-dir state_repo/snapshots \
            --latest state_repo/latest.json \
            --diff out/diff.json \
            --issue-body out/issue.md \
            --issue-title out/issue_title.txt \
            $prev_arg

      - name: Determine if changes occurred
        id: diff
        run: |
          python3 - <<'PY'
          import json
          import os

          with open('out/diff.json', 'r', encoding='utf-8') as handle:
              diff = json.load(handle)
          has_changes = bool(diff.get('added') or diff.get('removed'))

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as handle:
              handle.write(f"has_changes={'true' if has_changes else 'false'}\n")
          PY

      - name: Create issue for changes
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const title = fs.readFileSync('out/issue_title.txt', 'utf8').trim();
            const body = fs.readFileSync('out/issue.md', 'utf8');
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });

      - name: Commit snapshot to state branch
        run: |
          set -euo pipefail
          cd state_repo
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add snapshots latest.json
          if git diff --cached --quiet; then
            echo "No snapshot changes to commit."
            exit 0
          fi
          git commit -m "Snapshot signed books $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          git push origin state
